# Disaster Response Coordination App - Development Makefile
# Using UV package manager for Python dependencies

.PHONY: help install dev test lint format clean docker-up docker-down db-migrate db-seed

# Default target
help:
	@echo "Disaster Response Coordination App - Development Commands"
	@echo ""
	@echo "ğŸ“¦ Setup Commands:"
	@echo "  dev-setup    - Complete development environment setup"
	@echo "  install      - Install all dependencies (backend + frontend)"
	@echo "  create-env   - Create environment file from template"
	@echo ""
	@echo "ğŸš€ Development Commands:"
	@echo "  dev-backend  - Run FastAPI backend with hot reload"
	@echo "  dev-frontend - Run React frontend development server"
	@echo "  dev          - Run both backend and frontend concurrently"
	@echo ""
	@echo "ğŸ³ Docker Commands:"
	@echo "  docker-up    - Start all services with Docker Compose"
	@echo "  docker-down  - Stop all Docker services"
	@echo "  docker-build - Build all Docker images"
	@echo "  docker-dev   - Start development services (DB + Redis only)"
	@echo "  docker-logs  - View logs from all services"
	@echo "  docker-clean - Clean up containers and volumes"
	@echo ""
	@echo "ğŸ—ƒï¸  Database Commands:"
	@echo "  db-migrate   - Run database migrations"
	@echo "  db-seed      - Load sample data"
	@echo "  db-reset     - Reset database (âš ï¸  destructive)"
	@echo ""
	@echo "ğŸ§ª Testing & Quality:"
	@echo "  test         - Run all tests"
	@echo "  test-backend - Run backend tests only"
	@echo "  test-frontend- Run frontend tests only"
	@echo "  lint         - Run linting"
	@echo "  format       - Format code"
	@echo ""
	@echo "ğŸ› ï¸  Utilities:"
	@echo "  clean        - Clean build artifacts and caches"
	@echo "  logs         - Show application logs"
	@echo "  agent-status - Check AI agent status"

# ==============================================================================
# ğŸ“¦ SETUP COMMANDS
# ==============================================================================

dev-setup: create-env install docker-dev db-migrate db-seed
	@echo "âœ… Development environment setup complete!"
	@echo ""
	@echo "ğŸš€ Next steps:"
	@echo "  1. Update ai_services/.env with your OpenAI API key"
	@echo "  2. Run 'make dev' to start development servers"
	@echo "  3. Visit http://localhost:3000 for frontend"
	@echo "  4. Visit http://localhost:8000/docs for API docs"

# Installation
install: install-backend install-frontend
	@echo "âœ… All dependencies installed successfully!"

install-backend:
	@echo "ğŸ“¦ Installing backend dependencies with UV..."
	@cd ai_services && uv sync
	@echo "âœ… Backend dependencies installed"

install-frontend:
	@echo "ğŸ“¦ Installing frontend dependencies with pnpm..."
	@cd frontend && pnpm install
	@echo "âœ… Frontend dependencies installed"

create-env:
	@echo "ğŸ“ Creating environment file..."
	@if [ ! -f ai_services/.env ]; then \
		cp ai_services/.env.example ai_services/.env; \
		echo "âœ… Created ai_services/.env from template"; \
		echo "âš ï¸  Please edit ai_services/.env with your configuration"; \
	else \
		echo "â„¹ï¸  Environment file already exists"; \
	fi

# ==============================================================================
# ğŸš€ DEVELOPMENT COMMANDS  
# ==============================================================================

dev:
	@echo "ğŸš€ Starting development servers..."
	@echo "Backend: http://localhost:8000"
	@echo "Frontend: http://localhost:3000"
	@echo "API Docs: http://localhost:8000/docs"
	@$(MAKE) -j2 dev-backend dev-frontend

dev-backend:
	@echo "ğŸ Starting FastAPI backend with hot reload..."
	@cd ai_services && uv run uvicorn main:app --reload --host 0.0.0.0 --port 8000

dev-frontend:
	@echo "âš›ï¸  Starting React frontend development server..."
	@cd frontend && pnpm dev

# ==============================================================================
# ğŸ³ DOCKER COMMANDS
# ==============================================================================

docker-up:
	@echo "ğŸ³ Starting all services with Docker Compose..."
	@docker-compose up -d
	@echo "âœ… Services started! Check status with 'docker-compose ps'"

docker-down:
	@echo "ğŸ›‘ Stopping all Docker services..."
	@docker-compose down

docker-build:
	@echo "ğŸ”¨ Building all Docker images..."
	@docker-compose build

docker-dev:
	@echo "ğŸ³ Starting development services (PostgreSQL + Redis)..."
	@docker-compose up -d postgres redis
	@echo "âœ… Development services started"

docker-logs:
	@echo "ğŸ“‹ Showing Docker logs..."
	@docker-compose logs -f

docker-clean:
	@echo "ğŸ§¹ Cleaning Docker resources..."
	@docker-compose down -v
	@docker system prune -f
	@echo "âœ… Docker cleanup complete"

# ==============================================================================
# ğŸ—ƒï¸  DATABASE COMMANDS
# ==============================================================================

db-migrate:
	@echo "ğŸ—ƒï¸  Running database migrations..."
	@cd ai_services && uv run alembic upgrade head
	@echo "âœ… Database migrations complete"

db-seed:
	@echo "ğŸŒ± Loading sample data..."
	@docker-compose exec -T postgres psql -U postgres -d disaster_response -f /docker-entrypoint-initdb.d/002_sample_data.sql
	@echo "âœ… Sample data loaded"

db-reset:
	@echo "âš ï¸  This will reset the database. All data will be lost!"
	@read -p "Type 'yes' to continue: " confirm && [ "$$confirm" = "yes" ]
	@docker-compose down postgres
	@docker volume rm intelligihack-2025-final-round-challenge_postgres_data || true
	@docker-compose up -d postgres
	@sleep 10
	@$(MAKE) db-migrate db-seed
	@echo "âœ… Database reset complete"

# ==============================================================================
# ğŸ¤– AGENT COMMANDS
# ==============================================================================

run-agents:
	@echo "ğŸ¤– Starting AGNO agent services..."
	@cd ai_services && uv run python -m agno_agents.coordinator

agent-status:
	@echo "ğŸ¤– Checking AI agent status..."
	@curl -f http://localhost:8000/api/v1/agents/status 2>/dev/null || echo "âŒ Backend not running or agents not available"

restart-agents:
	@echo "ğŸ”„ Restarting AI agent services..."
	@curl -X POST http://localhost:8000/api/v1/agents/restart 2>/dev/null || echo "âŒ Backend not running"

# ==============================================================================
# ğŸ§ª TESTING & QUALITY
# ==============================================================================

test: test-backend test-frontend
	@echo "âœ… All tests completed!"

test-backend:
	@echo "ğŸ§ª Running backend tests..."
	@cd ai_services && uv run pytest -v --cov=. --cov-report=html --cov-report=term

test-frontend:
	@echo "ğŸ§ª Running frontend tests..."
	@cd frontend && pnpm test --run --coverage

test-agents:
	@echo "ğŸ¤– Testing AGNO agents..."
	@cd ai_services && uv run pytest tests/test_agents/ -v

lint:
	@echo "ğŸ” Running linting..."
	@cd ai_services && uv run ruff check .
	@cd ai_services && uv run mypy .
	@cd frontend && pnpm lint

format:
	@echo "ğŸ¨ Formatting code..."
	@cd ai_services && uv run ruff format .
	@cd ai_services && uv run isort .
	@cd frontend && pnpm format

# ==============================================================================
# ğŸ› ï¸  UTILITIES
# ==============================================================================

clean:
	@echo "ğŸ§¹ Cleaning build artifacts and caches..."
	@# Python cache cleanup
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name ".coverage" -delete 2>/dev/null || true
	@rm -rf ai_services/htmlcov/ 2>/dev/null || true
	@# Frontend cache cleanup  
	@rm -rf frontend/dist/ 2>/dev/null || true
	@rm -rf frontend/node_modules/.cache/ 2>/dev/null || true
	@rm -rf frontend/coverage/ 2>/dev/null || true
	@echo "âœ… Cleanup complete!"

logs:
	@echo "ğŸ“‹ Application logs:"
	@if [ -f ai_services/logs/app.log ]; then \
		tail -f ai_services/logs/app.log; \
	else \
		echo "â„¹ï¸  No log file found. Run the application first."; \
	fi

# ==============================================================================
# ğŸ¥ HEALTH CHECKS
# ==============================================================================

check-backend:
	@echo "ğŸ¥ Checking backend health..."
	@curl -f http://localhost:8000/health 2>/dev/null && echo "âœ… Backend healthy" || echo "âŒ Backend not responding"

check-frontend:
	@echo "ğŸ¥ Checking frontend..."
	@curl -f http://localhost:3000 2>/dev/null && echo "âœ… Frontend healthy" || echo "âŒ Frontend not responding"

check-docker:
	@echo "ğŸ³ Checking Docker services..."
	@docker-compose ps

check: check-backend check-frontend check-docker
	@echo "âœ… Health check complete"

# ==============================================================================
# ğŸ“‹ INFORMATION
# ==============================================================================

status:
	@echo "ğŸ“Š System Status:"
	@echo "=================="
	@$(MAKE) check
	@echo ""
	@echo "ğŸ”— Service URLs:"
	@echo "  Frontend:    http://localhost:3000"
	@echo "  Backend API: http://localhost:8000" 
	@echo "  API Docs:    http://localhost:8000/docs"
	@echo "  Database:    localhost:5432"
	@echo "  Redis:       localhost:6379"

info:
	@echo "â„¹ï¸  Disaster Response Coordination System"
	@echo "========================================="
	@echo ""
	@echo "ğŸ“ Project Structure:"
	@echo "  ai_services/  - FastAPI backend with AGNO agents"
	@echo "  frontend/     - React frontend application"
	@echo "  docs/         - Documentation"
	@echo ""
	@echo "ğŸ”§ Technologies:"
	@echo "  Backend:  FastAPI, PostgreSQL, Redis, AGNO, OpenAI"
	@echo "  Frontend: React 19, TypeScript, Tailwind CSS"
	@echo "  Tools:    Docker, UV, pnpm, Make"
	@echo ""
	@echo "ğŸ“– Quick Start:"
	@echo "  1. make dev-setup    # Complete setup"
	@echo "  2. make dev          # Start development"
	@echo "  3. Visit http://localhost:3000"
